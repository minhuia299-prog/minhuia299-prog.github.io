<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BlueTriangle WebOS — Single File Full</title>
<style>
/* =========================
   BlueTriangle WebOS - Single File
   All CSS below
   ========================= */
:root{
  --bg1:#071023; --bg2:#0e2133;
  --panel:#0f1720; --accent:#00b8d4; --accent2:#00d4b3;
  --muted:#9aa6b2; --glass: rgba(255,255,255,0.03);
}
*{box-sizing:border-box;font-family:Inter,ui-sans-serif,system-ui,"Segoe UI",Roboto,"Helvetica Neue",Arial}
html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:#e6fbff}
a{color:var(--accent)}
/* Utility */
.hidden{display:none}
.center{text-align:center}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent2));border:none;padding:10px 12px;border-radius:8px;color:#042a2a;font-weight:700;cursor:pointer}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px;border-radius:8px;color:#e6fbff;cursor:pointer}
.small{padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);cursor:pointer}
.muted{color:var(--muted);font-size:13px}
.row{display:flex;gap:8px;align-items:center}
.col{display:flex;flex-direction:column;gap:8px}

/* Login page */
#login-screen{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;padding:16px}
.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:12px;padding:20px;width:420px;box-shadow:0 10px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.02)}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:6px}
.logoBox{width:54px;height:54px;border-radius:10px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center}
.logoBox svg{width:34px;height:34px}
.input{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#07131a;color:#e6fbff}

/* Desktop */
#desktop{display:none;position:fixed;inset:0;overflow:hidden}
.wallpaper{position:absolute;inset:0;background-image:linear-gradient(180deg,rgba(4,18,32,0.35),rgba(2,9,18,0.6));background-size:cover}
.icons{position:absolute;left:12px;top:12px;display:flex;flex-direction:column;gap:14px;z-index:10}
.icon{width:92px;text-align:center;cursor:pointer}
.icon .ico{width:64px;height:64;border-radius:12px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;margin:0 auto 8px;font-size:28px}
.icon span{font-size:13px;display:block;color:#e6fbff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Taskbar */
.taskbar{position:absolute;left:0;right:0;bottom:0;height:54px;background:rgba(2,6,12,0.7);backdrop-filter:blur(8px);display:flex;align-items:center;padding:8px 12px;gap:12px;border-top:1px solid rgba(255,255,255,0.02);z-index:40}
.start{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));cursor:pointer}
.start .miniLogo{width:36px;height:36;border-radius:8px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center}
.tray{margin-left:auto;display:flex;align-items:center;gap:10px;color:#e6fbff}

/* Start menu */
.startMenu{position:absolute;left:12px;bottom:72px;width:360px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-radius:12px;padding:12px;box-shadow:0 14px 40px rgba(0,0,0,0.6);display:none;z-index:60}
.tileGrid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}

/* Windows */
.win{position:absolute;width:760px;height:500px;background:linear-gradient(180deg,#071a24,#05202b);border-radius:12px;padding:0;border:1px solid rgba(255,255,255,0.04);box-shadow:0 18px 60px rgba(0,0,0,0.6);display:flex;flex-direction:column;z-index:30;overflow:hidden}
.titlebar{height:48px;display:flex;align-items:center;padding:0 12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));border-bottom:1px solid rgba(255,255,255,0.02)}
.title{flex:1;font-weight:700}
.controls{display:flex;gap:8px}
.ctrlBtn{width:36px;height:36;border-radius:8px;background:transparent;border:none;color:#e6fbff;cursor:pointer}
.content{flex:1;padding:12px;overflow:auto;color:#dff7fb}

/* small cards */
.card-small{background:rgba(255,255,255,0.02);padding:8px;border-radius:8px;margin-bottom:8px}

/* forms in windows */
.form-row{display:flex;gap:8px;align-items:center}
.input-sm{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#07131a;color:#e6fbff;flex:1}

/* canvas games */
canvas{border-radius:8px;display:block}

/* responsive */
@media (max-width:1000px){
  .win{width:94%;height:78%}
}
</style>
</head>
<body>

<!-- LOGIN SCREEN -->
<div id="login-screen">
  <div class="card" role="dialog" aria-modal="true" aria-label="Login">
    <div class="brand">
      <div class="logoBox" title="BlueTriangle"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><polygon points="12,3 22,20 2,20" fill="white"/></svg></div>
      <div>
        <div style="font-size:18px;font-weight:700">BlueTriangle WebOS</div>
        <div class="muted">Local demo — create account and sign in</div>
      </div>
    </div>

    <!-- Register -->
    <div id="panel-register">
      <div style="margin-top:12px">
        <input id="regUser" class="input" placeholder="Username (example: admin)" />
        <input id="regPass" class="input" type="password" placeholder="Password (example: 12345)" />
        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="registerUser()">Create account</button>
          <button class="small" onclick="showLogin()">Already have account</button>
        </div>
        <div class="muted" style="margin-top:8px">Note: Accounts are stored locally (IndexedDB + localStorage). Use for demo / GitHub Pages.</div>
      </div>
    </div>

    <!-- Login flow (step by step) -->
    <div id="panel-login" class="hidden">
      <div style="margin-top:12px">
        <input id="loginUser" class="input" placeholder="Username" />
        <input id="loginPass" class="input" type="password" placeholder="Password" />
        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="startLogin()">Next</button>
          <button class="small" onclick="showRegister()">Create new</button>
        </div>
      </div>
    </div>

    <div id="panel-otp" class="hidden" style="margin-top:10px">
      <div class="muted">Step 2: Enter one-time code (demo — code will be shown below)</div>
      <input id="otpInput" class="input" placeholder="6-digit code" />
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="verifyOtp()">Verify OTP</button>
        <button class="small" onclick="backToLogin()">Back</button>
      </div>
      <div id="otpHint" class="muted" style="margin-top:8px"></div>
    </div>

    <div id="panel-key" class="hidden" style="margin-top:10px">
      <div class="muted">Step 3: Security key / Passkey verification</div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" onclick="verifySecurityKey()">Verify Key</button>
        <button class="small" onclick="registerSecurityKey()">Register Key</button>
      </div>
      <div id="keyHint" class="muted" style="margin-top:8px"></div>
    </div>

  </div>
</div>

<!-- DESKTOP -->
<div id="desktop" class="hidden" aria-hidden="true">
  <div class="wallpaper"></div>

  <!-- icons -->
  <div class="icons" id="iconsRoot"></div>

  <!-- Start menu -->
  <div class="startMenu" id="startMenu">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div><div class="muted">Signed in as</div><div id="startUser" style="font-weight:700"></div></div>
      <div><div class="muted">BlueTriangle</div><div style="font-weight:700">WebOS</div></div>
    </div>
    <div class="tileGrid" id="storeGrid"></div>
  </div>

  <!-- Taskbar -->
  <div class="taskbar">
    <div class="start" id="startBtn" onclick="toggleStartMenu()">
      <div class="miniLogo"><svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><polygon points="12,3 22,20 2,20" fill="white"/></svg></div>
      <div style="font-weight:700">BlueTriangle</div>
    </div>
    <div class="tray">
      <div id="clockDisplay">--:--</div>
      <button class="small" onclick="logout()">Sign out</button>
    </div>
  </div>

  <!-- Window: App Store -->
  <div class="win hidden" id="win_appstore" style="left:80px;top:80px">
    <div class="titlebar"><div class="title">AppDL — App Store</div><div class="controls"><button class="ctrlBtn" onclick="closeWindow('win_appstore')">✕</button></div></div>
    <div class="content" id="appstoreContent"></div>
  </div>

  <!-- Window: AI -->
  <div class="win hidden" id="win_ai" style="left:120px;top:100px">
    <div class="titlebar"><div class="title">AI !#!</div><div class="controls"><button class="ctrlBtn" onclick="closeWindow('win_ai')">✕</button></div></div>
    <div class="content" id="aiContent">
      <div style="display:flex;flex-direction:column;height:100%">
        <div id="aiLog" style="flex:1;overflow:auto;padding:8px"></div>
        <div class="form-row" style="margin-top:8px">
          <input id="aiInput" class="input-sm" placeholder="Ask something to AI..." />
          <button class="btn" onclick="aiSend()">Send</button>
        </div>
        <div class="form-row" style="margin-top:8px;align-items:center">
          <input id="aiApiKey" class="input-sm" placeholder="Paste API key here (client-side, optional)" />
          <button class="small" onclick="saveAiKey()">Save key</button>
        </div>
        <div class="muted" style="margin-top:8px">Important: For production, use a server-side AI proxy. Storing API keys client-side is insecure but allowed for local demo.</div>
      </div>
    </div>
  </div>

  <!-- Window: CD Code -->
  <div class="win hidden" id="win_code" style="left:160px;top:120px">
    <div class="titlebar"><div class="title">CD Code — Editor</div><div class="controls"><button class="ctrlBtn" onclick="closeWindow('win_code')">✕</button></div></div>
    <div class="content">
      <div style="display:flex;flex-direction:column;height:100%">
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="runCode()">Run</button>
          <button class="small" onclick="saveSnippet()">Save Snippet</button>
        </div>
        <textarea id="codeArea" style="margin-top:8px;flex:1;border-radius:8px;padding:8px;background:#07131a;color:#dff7fb;resize:none" spellcheck="false">
<!-- HTML -->
<div style="font-family:system-ui;padding:20px"><h2>Hello from CD Code</h2><p>Edit HTML/CSS/JS then press Run.</p></div>

<!-- CSS -->
body{font-family:system-ui;color:#072a2a;}

<!-- JS -->
console.log('Hello from CD Code');
        </textarea>
        <iframe id="codeFrame" sandbox="allow-scripts" style="width:100%;height:180px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);margin-top:8px"></iframe>
      </div>
    </div>
  </div>

  <!-- Window: ShVid -->
  <div class="win hidden" id="win_shvid" style="left:200px;top:140px">
    <div class="titlebar"><div class="title">ShVid</div><div class="controls"><button class="ctrlBtn" onclick="closeWindow('win_shvid')">✕</button></div></div>
    <div class="content">
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;gap:8px;align-items:center">
          <input id="svTitle" class="input-sm" placeholder="Video title" />
          <input id="svFile" type="file" accept="video/*" />
          <button class="btn" onclick="uploadVideo()">Upload</button>
        </div>
        <div style="display:flex;gap:8px">
          <input id="svChannel" class="input-sm" placeholder="Channel name (optional)" />
          <button class="small" onclick="createChannel()">Create Channel</button>
        </div>
        <div id="svList" style="margin-top:8px;overflow:auto;max-height:420px"></div>
      </div>
    </div>
  </div>

  <!-- Window: TalkOut -->
  <div class="win hidden" id="win_talkout" style="left:240px;top:160px">
    <div class="titlebar"><div class="title">TalkOut</div><div class="controls"><button class="ctrlBtn" onclick="closeWindow('win_talkout')">✕</button></div></div>
    <div class="content">
      <div style="display:flex;flex-direction:column;gap:8px">
        <div style="display:flex;gap:8px">
          <input id="toText" class="input-sm" placeholder="Write something..." />
          <input id="toImage" type="file" accept="image/*" />
          <button class="btn" onclick="postTalk()">Post</button>
        </div>
        <div id="toFeed" style="margin-top:8px;overflow:auto;max-height:420px"></div>
      </div>
    </div>
  </div>

  <!-- Window: Snake -->
  <div class="win hidden" id="win_snake" style="left:280px;top:180px">
    <div class="titlebar"><div class="title">Snake</div><div class="controls"><button class="ctrlBtn" onclick="closeWindow('win_snake')">✕</button></div></div>
    <div class="content">
      <div style="display:flex;flex-direction:column;height:100%">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn" onclick="startSnake()">Start</button>
          <button class="small" onclick="stopSnake()">Stop</button>
          <div class="muted" style="margin-left:auto">Use arrow keys / W A S D</div>
        </div>
        <canvas id="snakeCanvas" width="720" height="360" style="background:#03121a;border-radius:8px"></canvas>
      </div>
    </div>
  </div>

  <!-- Window: Run Away -->
  <div class="win hidden" id="win_run" style="left:320px;top:200px">
    <div class="titlebar"><div class="title">Run Away!</div><div class="controls"><button class="ctrlBtn" onclick="closeWindow('win_run')">✕</button></div></div>
    <div class="content">
      <div style="display:flex;flex-direction:column;height:100%">
        <div style="display:flex;gap:8px;margin-bottom:8px">
          <button class="btn" onclick="startRun()">Start</button>
          <button class="small" onclick="stopRun()">Stop</button>
          <div class="muted" style="margin-left:auto">Use mouse to move player</div>
        </div>
        <canvas id="runCanvas" width="720" height="360" style="background:#001b24;border-radius:8px"></canvas>
      </div>
    </div>
  </div>

</div>

<script>
/* =============================
   BlueTriangle WebOS - Single File JS
   - All functions included, no truncation
   - Data persisted per-user using IndexedDB and localStorage
   ============================= */

/* ---------- IndexedDB wrapper for blobs (videos/images) ---------- */
const DB_NAME = 'bt_webos_db_v1';
const DB_VERSION = 1;
let idb = null;
function openDB(){
  return new Promise((resolve, reject) => {
    if (idb) return resolve(idb);
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = (ev) => {
      const db = ev.target.result;
      if (!db.objectStoreNames.contains('blobs')) db.createObjectStore('blobs', { keyPath: 'id' });
      if (!db.objectStoreNames.contains('channels')) db.createObjectStore('channels', { keyPath: 'id' });
      if (!db.objectStoreNames.contains('posts')) db.createObjectStore('posts', { keyPath: 'id', autoIncrement: true });
    };
    req.onsuccess = () => { idb = req.result; resolve(idb); };
    req.onerror = (e) => reject(e);
  });
}
async function storeBlob(id, blob, meta = {}) {
  const db = await openDB();
  return new Promise((resolve, reject) => {
    const tx = db.transaction('blobs','readwrite');
    const store = tx.objectStore('blobs');
    store.put({ id, blob, meta });
    tx.oncomplete = () => resolve(true);
    tx.onerror = (e) => reject(e);
  });
}
async function getBlob(id){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('blobs','readonly'); const store = tx.objectStore('blobs');
    const req = store.get(id);
    req.onsuccess = ()=> resolve(req.result || null);
    req.onerror = (e)=> reject(e);
  });
}
async function listBlobs(){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('blobs','readonly'); const store = tx.objectStore('blobs');
    const res = [];
    const cursor = store.openCursor();
    cursor.onsuccess = (e)=>{ const c = e.target.result; if(!c) return resolve(res); res.push(c.value); c.continue(); };
    cursor.onerror = (e)=> reject(e);
  });
}
async function removeBlob(id){
  const db = await openDB();
  return new Promise((resolve,reject)=>{
    const tx = db.transaction('blobs','readwrite');
    tx.objectStore('blobs').delete(id);
    tx.oncomplete = ()=>resolve(true); tx.onerror=(e)=>reject(e);
  });
}

/* ---------- Simple helpers ---------- */
function $(id){ return document.getElementById(id); }
function uuid(){ return 'id-' + Math.random().toString(36).slice(2,12); }
function safeJSON(v){ try{return JSON.parse(v)}catch(e){return null} }
function now(){ return Date.now(); }

/* ---------- Crypto: derive password hash with Web Crypto PBKDF2 ---------- */
async function derivePasswordHash(password, saltBase64){
  const enc = new TextEncoder();
  const salt = saltBase64 ? Uint8Array.from(atob(saltBase64), c => c.charCodeAt(0)) : crypto.getRandomValues(new Uint8Array(16));
  const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']);
  const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt, iterations: 150000, hash: 'SHA-256' }, keyMaterial, { name:'AES-GCM', length:256 }, true, ['encrypt','decrypt']);
  const raw = await crypto.subtle.exportKey('raw', key);
  // return base64 of salt and derived raw
  const hashB64 = btoa(String.fromCharCode(...new Uint8Array(raw)));
  const saltB64 = btoa(String.fromCharCode(...new Uint8Array(salt)));
  return { hash: hashB64, salt: saltB64 };
}
async function verifyPassword(password, saltB64, expectedHashB64){
  try{
    const enc = new TextEncoder();
    const salt = Uint8Array.from(atob(saltB64), c => c.charCodeAt(0));
    const keyMaterial = await crypto.subtle.importKey('raw', enc.encode(password), 'PBKDF2', false, ['deriveBits', 'deriveKey']);
    const key = await crypto.subtle.deriveKey({ name: 'PBKDF2', salt, iterations: 150000, hash: 'SHA-256' }, keyMaterial, { name:'AES-GCM', length:256 }, true, ['encrypt','decrypt']);
    const raw = await crypto.subtle.exportKey('raw', key);
    const h = btoa(String.fromCharCode(...new Uint8Array(raw)));
    return h === expectedHashB64;
  }catch(e){ console.error(e); return false; }
}

/* ---------- User & storage (localStorage + IndexedDB) ---------- */
const LS_USERS = 'bt_users_v1'; // stores map {username: {salt,hash,created,webAuthnRegistered,deviceToken}}
const LS_INSTALLED = 'bt_installed_v1'; // map username -> array of installed apps
const LS_SHVID_META = 'bt_shvid_meta_v1'; // map username -> array of {id,title,channel,blobId,created}
const LS_TALK_POSTS = 'bt_talk_posts_v1'; // map username -> array of post ids (stored in indexedDB 'posts' store)

/* create default admin if not exist */
(function initSample(){
  const usersRaw = localStorage.getItem(LS_USERS);
  const users = usersRaw ? JSON.parse(usersRaw) : {};
  if(!users['admin']){
    // create default admin with password '12345'
    (async ()=>{
      const res = await derivePasswordHash('12345');
      users['admin'] = { salt: res.salt, hash: res.hash, created: Date.now(), webAuthn: null, deviceToken: null };
      localStorage.setItem(LS_USERS, JSON.stringify(users));
    })();
  }
})();

/* ---------- App list metadata ---------- */
const ALL_APPS = [
  { id:'appstore', name:'AppDL', desc:'Install apps from the store', icon:svgIconAppStore() },
  { id:'ai', name:'AI !#!', desc:'Chat with AI (paste API key)', icon:svgIconAI() },
  { id:'code', name:'CD Code', desc:'Edit and run HTML/CSS/JS', icon:svgIconCode() },
  { id:'shvid', name:'ShVid', desc:'Upload & watch videos', icon:svgIconShvid() },
  { id:'talkout', name:'TalkOut', desc:'Post text and images', icon:svgIconTalk() },
  { id:'snake', name:'Snake', desc:'Classic snake game', icon:svgIconSnake() },
  { id:'run', name:'Run Away!', desc:'Dodge obstacles with mouse', icon:svgIconRun() }
];

/* ---------- UI flow: show/hide login/register panels ---------- */
function showLogin(){ $('panel-register').classList.add('hidden'); $('panel-login').classList.remove('hidden'); $('panel-otp').classList.add('hidden'); $('panel-key').classList.add('hidden'); }
function showRegister(){ $('panel-register').classList.remove('hidden'); $('panel-login').classList.add('hidden'); $('panel-otp').classList.add('hidden'); $('panel-key').classList.add('hidden'); }
showRegister(); // default

/* ---------- Register user ---------- */
async function registerUser(){
  const username = ($('regUser').value || '').trim();
  const password = $('regPass').value || '';
  if(!username || !password){ alert('Please provide username and password'); return; }
  const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
  if(users[username]){ alert('User already exists'); return; }
  const {hash, salt} = await derivePasswordHash(password);
  users[username] = { salt, hash, created: Date.now(), webAuthn: null, deviceToken: null, aiApiKey: '' };
  localStorage.setItem(LS_USERS, JSON.stringify(users));
  // create default installed apps list (only appstore)
  const installed = JSON.parse(localStorage.getItem(LS_INSTALLED) || '{}'); installed[username] = ['appstore']; localStorage.setItem(LS_INSTALLED, JSON.stringify(installed));
  alert('Account created. You can now sign in.');
  $('regUser').value=''; $('regPass').value='';
  showLogin();
}

/* ---------- Login flow (step 1 => password) ---------- */
let _loginSession = null;
async function startLogin(){
  const username = ($('loginUser').value || '').trim();
  const password = $('loginPass').value || '';
  if(!username || !password){ alert('Enter username & password'); return; }
  const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
  const user = users[username];
  if(!user){ alert('Invalid username or password'); return; }

  const ok = await verifyPassword(password, user.salt, user.hash);
  if(!ok){ alert('Invalid username or password'); return; }

  // password OK -> create login session
  _loginSession = { username, created: Date.now() };

  // generate demo OTP (in real use you'd send via SMS/email/TOTP)
  const otp = String(Math.floor(100000 + Math.random()*900000));
  _loginSession.otp = otp;
  $('otpHint').textContent = `Demo OTP (for testing only): ${otp}`;
  $('panel-login').classList.add('hidden'); $('panel-otp').classList.remove('hidden'); $('panel-key').classList.add('hidden');
}

/* ---------- OTP verify (step 2) ---------- */
async function verifyOtp(){
  const code = ($('otpInput').value || '').trim();
  if(!_loginSession){ alert('No login session'); return; }
  if(code !== _loginSession.otp){ alert('Invalid OTP'); return; }
  // OTP ok -> go to step 3
  $('panel-otp').classList.add('hidden'); $('panel-key').classList.remove('hidden');
  $('keyHint').textContent = 'You can register a security key or verify existing one. If WebAuthn is supported, it will attempt. Otherwise use device token fallback.';
}

/* ---------- Security key (WebAuthn) / fallback ---------- */
async function registerSecurityKey(){
  if(!_loginSession){ alert('Start login first'); return; }
  // If WebAuthn available and is on https, attempt to create credential
  if(window.PublicKeyCredential && location.protocol === 'https:'){
    try{
      // Create a simple credential challenge (demo)
      const challenge = Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(32)));
      const pubKey = {
        challenge,
        rp: { name: "BlueTriangle WebOS" },
        user: { id: Uint8Array.from(new TextEncoder().encode(_loginSession.username)), name: _loginSession.username, displayName: _loginSession.username },
        pubKeyCredParams: [{ type: "public-key", alg: -7 }],
        timeout: 60000,
        attestation: "direct"
      };
      const cred = await navigator.credentials.create({ publicKey: pubKey });
      // We store the credential id in users (base64)
      const rawId = arrayBufferToBase64(cred.rawId);
      const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
      users[_loginSession.username].webAuthn = { id: rawId, created: Date.now() };
      localStorage.setItem(LS_USERS, JSON.stringify(users));
      alert('WebAuthn credential registered (demo). Now verify to sign in.');
    }catch(e){ console.error(e); alert('WebAuthn registration failed: ' + e.message); }
  } else {
    // fallback: create a device token and store
    const token = uuid();
    const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
    users[_loginSession.username].deviceToken = token;
    localStorage.setItem(LS_USERS, JSON.stringify(users));
    alert('Device token created and saved. You can now verify key to finish login.');
  }
}

async function verifySecurityKey(){
  if(!_loginSession){ alert('Start login first'); return; }
  const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
  const user = users[_loginSession.username];
  if(!user){ alert('User not found'); return; }
  // If webAuthn exists, attempt get()
  if(user.webAuthn && window.PublicKeyCredential && location.protocol === 'https:'){
    try{
      const allowId = base64ToArrayBuffer(user.webAuthn.id);
      const options = {
        challenge: Uint8Array.from(window.crypto.getRandomValues(new Uint8Array(32))),
        allowCredentials: [{ id: allowId, type: 'public-key' }],
        timeout: 60000
      };
      const assertion = await navigator.credentials.get({ publicKey: options });
      // In real server flow you'd verify assertion with server. Here we accept as success.
      finishLogin(_loginSession.username);
    }catch(e){ console.error(e); alert('WebAuthn verification failed: ' + e.message); }
  } else if(user.deviceToken){
    // ask device token to confirm
    const t = prompt('Enter your device token (created earlier) — check your account storage:');
    if(t === user.deviceToken){ finishLogin(_loginSession.username); } else alert('Device token mismatch');
  } else {
    // If no key registered, prompt to register
    if(confirm('No security key registered. Would you like to register a device token now?')){ registerSecurityKey(); } else { alert('You must register a security key/device to proceed in this demo'); }
  }
}

/* ---------- Finalize login: open desktop ---------- */
function finishLogin(username){
  // persist current user session in memory
  window._BT_USER = username;
  // ensure installed apps list exists
  const installed = JSON.parse(localStorage.getItem(LS_INSTALLED) || '{}');
  if(!installed[username]){ installed[username] = ['appstore']; localStorage.setItem(LS_INSTALLED, JSON.stringify(installed)); }
  // show desktop
  $('login-screen').style.display = 'none';
  $('desktop').classList.remove('hidden'); $('desktop').style.display = 'block';
  $('startUser').textContent = username;
  renderIcons();
  renderStartStore();
  updateClock(); setInterval(updateClock,1000);
  loadUserDataIntoUI();
  _loginSession = null;
}

/* ---------- Logout ---------- */
function logout(){
  if(confirm('Sign out?')){ window._BT_USER = null; $('desktop').style.display='none'; $('login-screen').style.display='flex'; showLogin(); }
}

/* ---------- Clock ---------- */
function updateClock(){ const d = new Date(); $('clockDisplay').textContent = d.toLocaleTimeString(); }

/* ---------- Render icons (only installed apps) ---------- */
function renderIcons(){
  const root = $('iconsRoot'); root.innerHTML = '';
  const installed = JSON.parse(localStorage.getItem(LS_INSTALLED) || '{}');
  const list = installed[window._BT_USER] || ['appstore'];
  list.forEach(appId=>{
    const app = ALL_APPS.find(x=>x.id===appId);
    if(!app) return;
    const div = document.createElement('div'); div.className='icon';
    div.innerHTML = `<div class="ico">${app.icon}</div><span>${app.name}</span>`;
    div.onclick = ()=> openApp(appId);
    root.appendChild(div);
  });
}

/* ---------- Start menu / store render ---------- */
function toggleStartMenu(){ const el = $('startMenu'); el.style.display = el.style.display==='block' ? 'none' : 'block'; }
function renderStartStore(){
  const grid = $('storeGrid'); grid.innerHTML='';
  ALL_APPS.forEach(a=>{
    const tile = document.createElement('div'); tile.className='card-small';
    tile.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:46px;height:46;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02)">${a.icon}</div><div><div style="font-weight:700">${a.name}</div><div class="muted" style="font-size:12px">${a.desc}</div></div></div><div style="margin-top:8px"><button class="small" onclick="openAppInfo('${a.id}')">Open</button> <button class="small" onclick="installApp('${a.id}')">Install</button></div>`;
    grid.appendChild(tile);
  });
  // populate appstore content window too
  const storeContent = $('appstoreContent'); storeContent.innerHTML = '';
  ALL_APPS.forEach(a=>{
    const wrapper = document.createElement('div'); wrapper.className='card-small';
    wrapper.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="width:46px;height:46;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.02)">${a.icon}</div><div style="flex:1"><div style="font-weight:700">${a.name}</div><div class="muted" style="font-size:12px">${a.desc}</div></div><div><button class="btn" onclick="installApp('${a.id}')">Install</button></div></div>`;
    storeContent.appendChild(wrapper);
  });
}

/* ---------- Install app (appstore) ---------- */
function installApp(appId){
  if(!window._BT_USER){ alert('Sign in first'); return; }
  const installed = JSON.parse(localStorage.getItem(LS_INSTALLED) || '{}');
  const userList = installed[window._BT_USER] || [];
  if(userList.includes(appId)){ alert('Already installed'); return; }
  userList.push(appId);
  installed[window._BT_USER] = userList;
  localStorage.setItem(LS_INSTALLED, JSON.stringify(installed));
  renderIcons();
  alert('Installed ' + appId);
}

/* ---------- Open app windows ---------- */
function openApp(appId){
  if(!window._BT_USER){ alert('Sign in first'); return; }
  const installed = JSON.parse(localStorage.getItem(LS_INSTALLED) || {});
  const userList = installed[window._BT_USER] || [];
  if(!userList.includes(appId) && appId !== 'appstore'){ alert('Not installed. Please install from AppDL'); return; }
  switch(appId){
    case 'appstore': $('win_appstore').classList.remove('hidden'); break;
    case 'ai': $('win_ai').classList.remove('hidden'); break;
    case 'code': $('win_code').classList.remove('hidden'); break;
    case 'shvid': $('win_shvid').classList.remove('hidden'); renderShvidList(); break;
    case 'talkout': $('win_talkout').classList.remove('hidden'); renderTalkFeed(); break;
    case 'snake': $('win_snake').classList.remove('hidden'); break;
    case 'run': $('win_run').classList.remove('hidden'); break;
    default: alert('App not available'); break;
  }
}

/* ---------- Close window ---------- */
function closeWindow(id){ $(id).classList.add('hidden'); }

/* ---------- Open app info (start menu) ---------- */
function openAppInfo(id){
  // show store window and focus the app entry
  $('win_appstore').classList.remove('hidden');
}

/* ---------- CD Code: run user code in iframe ---------- */
function runCode(){
  const text = $('codeArea').value || '';
  // split by comments markers
  const html = (text.split('<!-- HTML -->')[1] || '').split('<!-- CSS -->')[0] || (text.includes('<!-- HTML -->')? (text.split('<!-- HTML -->')[1]) : '');
  const css = (text.split('<!-- CSS -->')[1] || '').split('<!-- JS -->')[0] || '';
  const js = (text.split('<!-- JS -->')[1] || '') || '';
  const doc = `<!doctype html><html><head><meta charset="utf-8"><style>${css}</style></head><body>${html}<script>${js}<\/script></body></html>`;
  const ifr = $('codeFrame');
  ifr.src = 'data:text/html;charset=utf-8,' + encodeURIComponent(doc);
}
function saveSnippet(){
  const name = prompt('Snippet name:'); if(!name) return;
  const snippets = JSON.parse(localStorage.getItem('bt_snippets_' + (window._BT_USER || 'guest')) || '{}');
  snippets[name] = $('codeArea').value;
  localStorage.setItem('bt_snippets_' + (window._BT_USER || 'guest'), JSON.stringify(snippets));
  alert('Saved snippet: ' + name);
}

/* ---------- AI App: local demo + API spot ----------
   NOTE: This is the ONLY place to paste client-side API key if you accept risks.
   Recommended: implement a server-side proxy to keep keys secret.
*/
function saveAiKey(){
  const key = $('aiApiKey').value.trim();
  const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
  if(!users[window._BT_USER]){ alert('User missing'); return; }
  users[window._BT_USER].aiApiKey = key;
  localStorage.setItem(LS_USERS, JSON.stringify(users));
  alert('API key saved locally for this user (insecure). For production, use server proxy.');
}

/* AI send message */
async function aiSend(){
  const text = ($('aiInput').value || '').trim();
  if(!text) return;
  appendAiLog('You', text);
  $('aiInput').value = '';
  const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
  const key = users[window._BT_USER] && users[window._BT_USER].aiApiKey ? users[window._BT_USER].aiApiKey.trim() : '';
  // If no key, respond demo
  if(!key){
    setTimeout(()=> appendAiLog('AI !#!', `Demo response: I received "${text}". You can paste an API key in the input below to call a real model.`), 700);
    return;
  }
  // If key exists, attempt to call OpenAI Chat Completions (you may change provider / endpoint)
  // WARNING: calling provider directly from client exposes key — for production, use a server proxy.
  appendAiLog('AI !#!', 'Thinking (calling provider)...');
  try{
    // NOTE: This example calls OpenAI v1 chat completions. Change as needed.
    const resp = await fetch('https://api.openai.com/v1/chat/completions', {
      method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization': 'Bearer ' + key },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [{ role:'user', content:text }],
        temperature: 0.7,
        max_tokens: 512
      })
    });
    if(!resp.ok){
      const txt = await resp.text();
      appendAiLog('AI !#!', `Provider error: ${resp.status} ${txt}`);
      return;
    }
    const data = await resp.json();
    const message = (data?.choices && data.choices[0] && (data.choices[0].message?.content || data.choices[0].text)) || JSON.stringify(data);
    appendAiLog('AI !#!', message);
  }catch(e){
    appendAiLog('AI !#!', 'Error calling provider: ' + e.message);
  }
}
function appendAiLog(who, text){
  const log = $('aiLog'); const p = document.createElement('div'); p.className='card-small'; p.innerHTML = `<b>${who}:</b> ${escapeHtml(text)}`; log.appendChild(p); log.scrollTop = log.scrollHeight;
}

/* ---------- ShVid: upload & list videos (IndexedDB + metadata) ---------- */
async function uploadVideo(){
  const fileEl = $('svFile'); if(!fileEl.files || fileEl.files.length===0){ alert('Choose a video'); return; }
  const file = fileEl.files[0]; const title = ($('svTitle').value || file.name).trim();
  // create blob id and store in indexedDB
  const id = uuid();
  await storeBlob(id, file, { owner: window._BT_USER, title, created: now(), type: 'video' });
  // store metadata per-user
  const metaAll = JSON.parse(localStorage.getItem(LS_SHVID_META) || '{}');
  const arr = metaAll[window._BT_USER] || [];
  arr.unshift({ id, title, channel: $('svChannel').value || 'Default', created: now() });
  metaAll[window._BT_USER] = arr;
  localStorage.setItem(LS_SHVID_META, JSON.stringify(metaAll));
  $('svTitle').value=''; $('svFile').value='';
  alert('Uploaded (stored locally)');
  renderShvidList();
}
async function renderShvidList(){
  const target = $('svList'); target.innerHTML = '';
  const metaAll = JSON.parse(localStorage.getItem(LS_SHVID_META) || '{}'); const arr = metaAll[window._BT_USER] || [];
  if(arr.length===0) target.innerHTML = '<div class="muted">No videos yet.</div>';
  for(const m of arr){
    const wrapper = document.createElement('div'); wrapper.className='card-small';
    wrapper.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="flex:1"><div style="font-weight:700">${escapeHtml(m.title)}</div><div class="muted" style="font-size:12px">${new Date(m.created).toLocaleString()} — Channel: ${escapeHtml(m.channel)}</div></div><div><button class="small" onclick="playVideo('${m.id}')">Play</button> <button class="small" onclick="deleteVideo('${m.id}')">Delete</button></div></div>`;
    target.appendChild(wrapper);
  }
}
async function playVideo(id){
  const rec = await getBlob(id); if(!rec){ alert('Video not found'); return; }
  const blob = rec.blob;
  // create a player window (generic)
  const win = createTemporaryWindow('ShVid Player', `<div style="display:flex;flex-direction:column;height:100%"><div style="font-weight:700;margin-bottom:8px">${escapeHtml(rec.meta.title || 'Video')}</div><video controls style="width:100%;height:100%;max-height:420px" src="${URL.createObjectURL(blob)}"></video></div>`);
  document.body.appendChild(win); makeDraggable(win);
}
async function deleteVideo(id){
  if(!confirm('Delete video?')) return;
  await removeBlob(id);
  const metaAll = JSON.parse(localStorage.getItem(LS_SHVID_META) || '{}'); const arr = metaAll[window._BT_USER] || [];
  metaAll[window._BT_USER] = arr.filter(x=>x.id !== id);
  localStorage.setItem(LS_SHVID_META, JSON.stringify(metaAll));
  renderShvidList();
}
async function createChannel(){
  const name = ($('svChannel').value || '').trim(); if(!name){ alert('Enter channel name'); return; }
  // store channel as blob entry for simplicity
  const id = uuid(); await storeBlob(id, new Blob([], {type:'application/json'}), { owner: window._BT_USER, channel: name, created: now(), type:'channel' });
  alert('Channel created');
}

/* ---------- TalkOut: posts (text + image) ---------- */
async function postTalk(){
  const text = ($('toText').value || '').trim();
  const fileEl = $('toImage');
  let imageId = null;
  if(fileEl.files && fileEl.files[0]){
    const f = fileEl.files[0]; imageId = uuid(); await storeBlob(imageId, f, { owner: window._BT_USER, type:'image', created: now() });
    fileEl.value = '';
  }
  const post = { user: window._BT_USER, text, imageId, created: now() };
  // store posts in IndexedDB posts store
  const db = await openDB();
  const tx = db.transaction('posts','readwrite'); tx.objectStore('posts').add(post);
  tx.oncomplete = ()=> { $('toText').value=''; renderTalkFeed(); };
}
async function renderTalkFeed(){
  const target = $('toFeed'); target.innerHTML = '';
  const db = await openDB();
  const tx = db.transaction('posts','readonly'); const store = tx.objectStore('posts');
  const req = store.openCursor(null, 'prev');
  req.onsuccess = async (e)=>{ const cur = e.target.result; if(!cur) return; const p = cur.value;
    const div = document.createElement('div'); div.className='card-small';
    let inner = `<div style="display:flex;gap:8px;align-items:center"><div style="flex:1"><div style="font-weight:700">${escapeHtml(p.user || 'Guest')}</div><div class="muted" style="font-size:12px">${new Date(p.created).toLocaleString()}</div></div></div>`;
    inner += `<div style="margin-top:8px">${escapeHtml(p.text || '')}</div>`;
    if(p.imageId){
      const rec = await getBlob(p.imageId);
      if(rec && rec.blob){ inner += `<div style="margin-top:8px"><img src="${URL.createObjectURL(rec.blob)}" style="max-width:100%;border-radius:8px" /></div>`; }
    }
    div.innerHTML = inner;
    target.appendChild(div);
    cur.continue();
  };
  req.onerror = ()=> target.innerHTML = '<div class="muted">No posts</div>';
}

/* ---------- Games ---------- */
/* Snake */
let snake = null;
function startSnake(){
  const canvas = $('snakeCanvas'); if(!canvas) return;
  const ctx = canvas.getContext('2d'); const W = canvas.width, H = canvas.height, size = 18;
  let dir = {x:1,y:0}, snakeArr = [{x:6,y:8},{x:5,y:8},{x:4,y:8}], food = {x:10,y:8}, running = true;
  function spawnFood(){ food = { x: Math.floor(Math.random()*(W/size)), y: Math.floor(Math.random()*(H/size)) }; }
  function draw(){
    ctx.fillStyle = '#03121a'; ctx.fillRect(0,0,W,H);
    // move head
    const head = {x: snakeArr[0].x + dir.x, y: snakeArr[0].y + dir.y};
    // wall collision
    if(head.x < 0 || head.y < 0 || head.x >= W/size || head.y >= H/size || snakeArr.some(s=>s.x===head.x && s.y===head.y)){
      stopSnake(); alert('Game over'); return;
    }
    snakeArr.unshift(head);
    if(head.x === food.x && head.y === food.y){
      spawnFood();
    } else snakeArr.pop();
    // draw food
    ctx.fillStyle = '#ffcc00'; ctx.fillRect(food.x*size+4, food.y*size+4, size-8, size-8);
    // draw snake
    ctx.fillStyle = '#00e0d4'; snakeArr.forEach((s,i)=> ctx.fillRect(s.x*size+2, s.y*size+2, size-4, size-4));
  }
  function keyHandler(e){
    const k = e.key.toLowerCase();
    if(k==='a' || e.key==='ArrowLeft'){ if(dir.x!==1) dir={x:-1,y:0}; }
    if(k==='d' || e.key==='ArrowRight'){ if(dir.x!==-1) dir={x:1,y:0}; }
    if(k==='w' || e.key==='ArrowUp'){ if(dir.y!==1) dir={x:0,y:-1}; }
    if(k==='s' || e.key==='ArrowDown'){ if(dir.y!==-1) dir={x:0,y:1}; }
  }
  stopSnake(); // ensure cleared
  snake = { timer: setInterval(draw,120), keyHandler, running:true };
  window.addEventListener('keydown', keyHandler);
}
function stopSnake(){
  if(snake && snake.timer){ clearInterval(snake.timer); snake.timer = null; if(snake.keyHandler) window.removeEventListener('keydown', snake.keyHandler); snake = null; }
}

/* Run Away (mouse dodge) */
let runState = null;
function startRun(){
  const canvas = $('runCanvas'); if(!canvas) return;
  const ctx = canvas.getContext('2d'); const W = canvas.width, H = canvas.height;
  let player = {x:W/2, y:H-60, r:12}, enemies = [], score = 0;
  function spawn(){ enemies.push({x:Math.random()*W, y:-20, r:10 + Math.random()*10, vy:1 + Math.random()*2}); }
  function step(){
    ctx.clearRect(0,0,W,H);
    // spawn
    if(Math.random()<0.04) spawn();
    enemies.forEach(en=>{ en.y += en.vy; ctx.fillStyle='#ff6b6b'; ctx.beginPath(); ctx.arc(en.x,en.y,en.r,0,Math.PI*2); ctx.fill(); });
    // player
    ctx.fillStyle='#00ffd4'; ctx.beginPath(); ctx.arc(player.x, player.y, player.r,0,Math.PI*2); ctx.fill();
    // collision
    enemies = enemies.filter(en=>{
      const dx = en.x - player.x, dy = en.y - player.y;
      if(Math.hypot(dx,dy) < en.r + player.r){ stopRun(); alert('Hit! Score: ' + score); return false; }
      if(en.y > H + 50){ score += 1; return false; }
      return true;
    });
  }
  function moveHandler(e){ const r = canvas.getBoundingClientRect(); player.x = e.clientX - r.left; player.y = e.clientY - r.top; }
  stopRun();
  runState = { timer: setInterval(step, 30), moveHandler };
  canvas.addEventListener('mousemove', runState.moveHandler);
}
function stopRun(){ const canvas = $('runCanvas'); if(runState && runState.timer){ clearInterval(runState.timer); if(runState.moveHandler) canvas.removeEventListener('mousemove', runState.moveHandler); runState = null; } }

/* ---------- Utilities: create temporary / generic window ---------- */
function createTemporaryWindow(title, html){
  const tpl = document.createElement('div'); tpl.className = 'win'; tpl.style.left = (120 + Math.random()*200) + 'px'; tpl.style.top = (100 + Math.random()*120) + 'px';
  tpl.innerHTML = `<div class="titlebar"><div class="title">${escapeHtml(title)}</div><div class="controls"><button class="ctrlBtn">✕</button></div></div><div class="content">${html}</div>`;
  tpl.querySelector('.ctrlBtn').onclick = ()=> tpl.remove();
  document.body.appendChild(tpl);
  makeDraggable(tpl);
  return tpl;
}

/* Make element draggable by its titlebar */
function makeDraggable(el){
  const header = el.querySelector('.titlebar');
  header.style.cursor = 'grab';
  let dragging = false, ox=0, oy=0, sx=0, sy=0;
  header.onpointerdown = (ev)=>{
    dragging = true; header.setPointerCapture(ev.pointerId); ox = ev.clientX; oy = ev.clientY;
    sx = parseInt(el.style.left) || el.getBoundingClientRect().left; sy = parseInt(el.style.top) || el.getBoundingClientRect().top;
    header.style.cursor = 'grabbing';
  };
  window.addEventListener('pointermove', (ev)=>{
    if(!dragging) return;
    const dx = ev.clientX - ox, dy = ev.clientY - oy;
    el.style.left = (sx + dx) + 'px';
    el.style.top = (sy + dy) + 'px';
  });
  window.addEventListener('pointerup', (ev)=>{
    if(dragging){ dragging = false; try{ header.releasePointerCapture(ev.pointerId) }catch(e){} header.style.cursor='grab'; }
  });
}

/* ---------- Load user-specific data into UI (ai key etc) ---------- */
function loadUserDataIntoUI(){
  const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
  const u = users[window._BT_USER] || {};
  $('aiApiKey').value = u.aiApiKey || '';
}

/* ---------- Escape HTML helper ---------- */
function escapeHtml(s){ return String(s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- Utilities for WebAuthn base64 conversions ---------- */
function arrayBufferToBase64(buffer){
  const bytes = new Uint8Array(buffer); let binary = ''; for (let i = 0; i < bytes.byteLength; i++) binary += String.fromCharCode(bytes[i]); return btoa(binary);
}
function base64ToArrayBuffer(base64){
  const binary = atob(base64); const len = binary.length; const bytes = new Uint8Array(len); for (let i=0;i<len;i++) bytes[i]=binary.charCodeAt(i); return bytes.buffer;
}

/* ---------- Load initial UI state after login ---------- */
async function renderInitialStateAfterLoad(){
  // show start menu icons etc
  renderStartStore();
}

/* ---------- Helpers for icons (inline SVGs as strings) ---------- */
function svgIconAppStore(){ return `<svg viewBox="0 0 24 24" width="28" height="28" xmlns="http://www.w3.org/2000/svg"><path d="M3 3h18v18H3z" fill="none"/><path d="M5 7h14v10H5z" fill="%23e6fbff" opacity="0.08"/><path d="M8 11h8v2H8z" fill="%23e6fbff"/></svg>`; }
function svgIconAI(){ return `<svg viewBox="0 0 24 24" width="28" height="28"><circle cx="12" cy="12" r="9" fill="%2300b8d4" /><path d="M8 12h8M12 8v8" stroke="%23fff" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>`; }
function svgIconCode(){ return `<svg viewBox="0 0 24 24" width="28" height="28"><rect x="3" y="4" width="18" height="16" rx="2" fill="%2300d4b3"/><path d="M9 8l-2 4 2 4M15 8l2 4-2 4" stroke="%2312171b" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>`; }
function svgIconShvid(){ return shvidLogoSvg(); }
function svgIconTalk(){ return `<svg viewBox="0 0 24 24" width="28" height="28"><rect x="3" y="4" width="18" height="14" rx="2" fill="%2300b8d4"/><path d="M7 8h10M7 12h6" stroke="%23fff" stroke-width="1.4" stroke-linecap="round"/></svg>`; }
function svgIconSnake(){ return `<svg viewBox="0 0 24 24" width="28" height="28"><rect x="3" y="4" width="18" height="16" rx="2" fill="%2300d4b3"/><path d="M6 10c1-3 5-4 8-2 3 2 2 6-2 7" stroke="%2308150a" stroke-width="1.6" stroke-linecap="round"/></svg>`; }
function svgIconRun(){ return `<svg viewBox="0 0 24 24" width="28" height="28"><circle cx="6" cy="6" r="2" fill="%2300b8d4"/><path d="M4 20c2-3 6-5 10-5 2.5 0 4.5 0 6-2" stroke="%23fff" stroke-width="1.4"/></svg>`; }

/* ShVid logo created programmatically (blue triangle with play) */
function shvidLogoSvg(){
  // a blue triangle with a white play triangle inside and a subtle drop shadow
  return `<svg viewBox="0 0 48 48" width="36" height="36" xmlns="http://www.w3.org/2000/svg">
    <defs><linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#00b8d4"/><stop offset="1" stop-color="#00d4b3"/></linearGradient></defs>
    <rect width="48" height="48" rx="8" fill="url(#g1)"/>
    <g transform="translate(12,11)"><polygon points="6,0 18,9 6,18" fill="white"/></g>
  </svg>`;
}

/* ---------- Escape hatch: public API to open apps from console ----------
   For debugging, you can call: openApp('ai'), installApp('ai'), etc.
*/
window.openApp = openApp;
window.installApp = installApp;

/* ---------- When DOM ready: wire up event handlers ---------- */
document.addEventListener('DOMContentLoaded', async ()=>{
  // attach login buttons
  $('panel-login').querySelectorAll('input').forEach(i=>i.addEventListener('keydown', (e)=>{ if(e.key==='Enter') startLogin(); }));
  // prepare icons root initially (only appstore available to unsigned)
  renderStartStore();
  // create icons root blank until login
  $('iconsRoot').innerHTML = '';
  // attach draggable for windows (titlebars)
  document.querySelectorAll('.win').forEach(w=> makeDraggable(w));
});

/* ---------- Load user data when desktop shown ---------- */
function loadUserDataIntoUI(){
  const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
  const user = users[window._BT_USER] || {};
  $('aiApiKey').value = user.aiApiKey || '';
  renderIcons();
  renderStartStore();
}

/* ---------- Utility to escape HTML for insertion ---------- */
function escapeHtml(s){ return String(s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ---------- Utility: load data for rendering on login ---------- */
function loadUserDataIntoUI(){
  const users = JSON.parse(localStorage.getItem(LS_USERS) || '{}');
  const u = users[window._BT_USER] || {};
  $('aiApiKey').value = u.aiApiKey || '';
  renderIcons();
  renderStartStore();
  renderShvidList();
  renderTalkFeed();
}

/* ---------- Finally: small helpers invoked from global scope ---------- */
window.registerUser = registerUser;
window.startLogin = startLogin;
window.verifyOtp = verifyOtp;
window.registerSecurityKey = registerSecurityKey;
window.verifySecurityKey = verifySecurityKey;
window.openAppInfo = openAppInfo;
window.installApp = installApp;
window.openApp = openApp;
window.closeWindow = closeWindow;
window.runCode = runCode;
window.saveSnippet = saveSnippet;
window.uploadVideo = uploadVideo;
window.renderShvidList = renderShvidList;
window.playVideo = playVideo;
window.deleteVideo = deleteVideo;
window.postTalk = postTalk;
window.renderTalkFeed = renderTalkFeed;
window.startSnake = startSnake;
window.stopSnake = stopSnake;
window.startRun = startRun;
window.stopRun = stopRun;

/* ---------- End of script ---------- */
</script>
</body>
</html>
